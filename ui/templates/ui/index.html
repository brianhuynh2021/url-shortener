<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>URL Shortener UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">üîó URL Shortener + Analytics (Tr·ª±c quan d·ªØ li·ªáu)</h1>

      <!-- Thanh user status (·∫©n n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p) -->
      <div id="userBar" class="hidden flex items-center gap-3">
        <span class="text-sm text-slate-700">
          ƒêƒÉng nh·∫≠p: <b id="userName" class="text-slate-900">user</b>
        </span>
        <button id="btnLogout" class="px-3 py-1.5 rounded bg-slate-800 text-white hover:bg-black">
          Logout
        </button>
      </div>

      <div>
        <a class="text-sm underline mr-4" href="/api/schema/swagger-ui/" target="_blank">Swagger</a>
        <a class="text-sm underline" href="/api/schema/redoc/" target="_blank">Redoc</a>
      </div>
    </header>

    <!-- Login Section (·∫©n sau khi ƒëƒÉng nh·∫≠p) -->
    <section id="loginSection" class="bg-white rounded-2xl shadow p-5 mb-6">
      <h2 class="font-semibold mb-3">ƒêƒÉng nh·∫≠p (JWT)</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="username" class="border rounded px-3 py-2" placeholder="username (hai ho·∫∑c admin)" />
        <input id="password" type="password" class="border rounded px-3 py-2" placeholder="password123" />
        <button id="btnLogin" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Login</button>
      </div>
      <p id="loginMsg" class="text-sm text-slate-600 mt-2"></p>
    </section>

    <section class="bg-white rounded-2xl shadow p-5 mb-6">
      <h2 class="font-semibold mb-3">T·∫°o link r√∫t g·ªçn</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <input id="title" class="border rounded px-3 py-2" placeholder="Title"/>
        <input id="target" class="border rounded px-3 py-2" placeholder="https://..."/>
        <input id="slug" class="border rounded px-3 py-2" placeholder="Slug (tu·ª≥ ch·ªçn)"/>
        <button id="btnCreate" class="bg-emerald-600 hover:bg-emerald-700 text-white rounded px-4 py-2">T·∫°o</button>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow p-5 mb-6">
      <h2 class="font-semibold mb-3">T√¨m ki·∫øm & l·ªçc</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <input id="q" class="border rounded px-3 py-2" placeholder="q theo title"/>
        <input id="created_at" class="border rounded px-3 py-2" placeholder="DD-MM-YYYY"/>
        <input id="page" class="border rounded px-3 py-2" placeholder="page (s·ªë)"/>
        <button id="btnReload" class="bg-slate-700 hover:bg-slate-800 text-white rounded px-4 py-2">Load links</button>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow p-5">
      <h2 class="font-semibold mb-3">Danh s√°ch link c·ªßa t√¥i</h2>
      <div id="list" class="space-y-3"></div>
      <div id="pager" class="mt-3 flex items-center justify-between hidden">
        <div id="pagerInfo" class="text-sm text-slate-600"></div>
        <div class="flex gap-2">
          <button id="btnPrev" class="px-3 py-1.5 rounded bg-slate-200 text-slate-800 disabled:opacity-50">Prev</button>
          <button id="btnNext" class="px-3 py-1.5 rounded bg-slate-800 text-white disabled:opacity-50">Next</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow p-5 w-full max-w-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modalTitle" class="font-semibold">Chi ti·∫øt</h3>
        <button onclick="closeModal()" class="text-slate-500 hover:text-black">‚úï</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
const state = { access: null, username: null };

function api(path, opts={}) {
  const headers = opts.headers || {};
  headers['Content-Type'] = headers['Content-Type'] || 'application/json';
  if (state.access) headers['Authorization'] = 'Bearer ' + state.access;
  return fetch(path, { ...opts, headers });
}
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
function toast(msg){ const p=document.getElementById('loginMsg'); p.textContent = msg; }

function todayDDMMYYYY(){
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

function toAPIDate(value){
  // Accept DD-MM-YYYY (preferred) or YYYY-MM-DD; return YYYY-MM-DD or ''
  const s = (value || '').trim();
  const mVN = s.match(/^(\d{2})-(\d{2})-(\d{4})$/);
  if(mVN) return `${mVN[3]}-${mVN[2]}-${mVN[1]}`;
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  return '';
}

function updateAuthUI(){
  const authed = !!state.access;
  document.getElementById('loginSection').classList.toggle('hidden', authed);
  document.getElementById('userBar').classList.toggle('hidden', !authed);
  document.getElementById('userName').textContent = state.username || 'user';
}

async function login(){
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  const res = await api('/api/auth/login/', { method:'POST', body: JSON.stringify({username, password}) });
  if(!res.ok){ toast('Login failed'); return; }
  const data = await res.json();
  state.access = data.access;
  state.username = username;
  localStorage.setItem('access', state.access);
  localStorage.setItem('username', state.username);
  toast('ƒêƒÉng nh·∫≠p OK');
  updateAuthUI();
  await loadLinks();
}

function logout(){
  state.access = null;
  state.username = null;
  localStorage.removeItem('access');
  localStorage.removeItem('username');
  updateAuthUI();
  document.getElementById('list').innerHTML = '';
  toast('ƒê√£ logout');
}

async function createLink(){
  const title = document.getElementById('title').value.trim();
  const target = document.getElementById('target').value.trim();
  const slug = document.getElementById('slug').value.trim();
  if(!state.access){ alert('H√£y ƒëƒÉng nh·∫≠p tr∆∞·ªõc.'); return; }
  if(!title || !target){ alert('Vui l√≤ng nh·∫≠p Title v√† URL ƒë√≠ch.'); return; }
  const payload = { title, target_url: target };
  if (slug) payload.slug = slug;
  const res = await api('/api/links/', { method:'POST', body: JSON.stringify(payload) });
  if(!res.ok){
    let msg = 'T·∫°o link th·∫•t b·∫°i';
    try { const err = await res.json(); msg = JSON.stringify(err); } catch(e) {}
    alert(msg);
    return;
  }
  // Clear inputs and refresh list
  document.getElementById('title').value = '';
  document.getElementById('target').value = '';
  document.getElementById('slug').value = '';
  toast('ƒê√£ t·∫°o link m·ªõi');
  await loadLinks();
}

async function loadLinks(){
  const q = document.getElementById('q').value.trim();
  const created_at_raw = document.getElementById('created_at').value.trim();
  const created_at = toAPIDate(created_at_raw);
  const page = document.getElementById('page').value.trim();
  const params = new URLSearchParams();
  if(q) params.set('q', q);
  if(created_at) params.set('created_at', created_at);
  if(page) params.set('page', page);
  const url = '/api/links/' + (params.toString()? ('?'+params.toString()) : '');
  const res = await api(url);
  const list = document.getElementById('list'); list.innerHTML = '';
  const pager = document.getElementById('pager'); pager.classList.add('hidden');
  if(!res.ok){
    if (res.status === 401) {
      list.append(el('<div class="p-3 bg-red-50 text-red-700 rounded">Unauthorized. H√£y ƒëƒÉng nh·∫≠p.</div>'));
      return;
    }
    if (res.status === 404) {
      list.append(el('<div class="p-3 bg-slate-50 text-slate-600 rounded">Kh√¥ng c√≥ d·ªØ li·ªáu cho trang n√†y (page kh√¥ng t·ªìn t·∫°i).</div>'));
      return;
    }
    let msg = 'L·ªói t·∫£i d·ªØ li·ªáu.';
    try { const err = await res.json(); msg = (err && err.detail) ? err.detail : JSON.stringify(err); } catch(e) {}
    list.append(el(`<div class="p-3 bg-red-50 text-red-700 rounded">${msg}</div>`));
    return;
  }
  const data = await res.json();
  const items = data.results || data;
  if(!items.length){
    list.append(el('<div class="p-3 bg-slate-50 text-slate-600 rounded">Ch∆∞a c√≥ link n√†o.</div>'));
    return;
  }
  for(const it of items){
    const shortUrl = location.origin + '/r/' + it.slug + '/';
    const card = el(`
      <div class="border rounded-xl p-4 flex flex-col md:flex-row md:items-center md:justify-between">
        <div class="space-y-1">
          <div class="font-medium">${it.title}</div>
          <div class="text-sm text-slate-600 break-all">${it.target_url}</div>
          <div class="text-sm">Slug: <span class="font-mono">${it.slug}</span> ‚Ä¢ Clicks: <b>${it.clicks_count ?? 0}</b></div>
          <div class="text-sm">Short: <a class="underline text-blue-700" href="${shortUrl}" target="_blank" rel="noopener" onclick="scheduleRefresh(1200)">${shortUrl}</a></div>
        </div>
        <div class="mt-3 md:mt-0 flex gap-2">
          <button class="px-3 py-2 rounded bg-emerald-600 text-white" onclick="showStats(${it.id}, '${it.title.replace(/'/g, "\\'")}')">Stats</button>
          <button class="px-3 py-2 rounded bg-indigo-600 text-white" onclick="showQR(${it.id}, '${it.slug}')">QR</button>
          <button class="px-3 py-2 rounded bg-yellow-500 text-white" onclick="editLink(${it.id}, '${it.title.replace(/'/g, "\\'")}', '${it.target_url.replace(/'/g, "\\'")}', '${it.slug.replace(/'/g, "\\'")}')">Edit</button>
          <button class="px-3 py-2 rounded bg-red-600 text-white" onclick="deleteLink(${it.id})">Del</button>
        </div>
      </div>
    `);
    list.append(card);
  }
  // Render pagination if paginated response
  if (data && typeof data === 'object' && 'results' in data) {
    renderPager(data);
  }
}

function openModal(title, bodyEl){
  document.getElementById('modalTitle').textContent = title;
  const body = document.getElementById('modalBody'); body.innerHTML=''; body.append(bodyEl);
  document.getElementById('modal').classList.remove('hidden'); document.getElementById('modal').classList.add('flex');
}
function closeModal(){ document.getElementById('modal').classList.add('hidden'); document.getElementById('modal').classList.remove('flex'); }

function getPageFromUrl(u){
  try { return Number(new URL(u, location.origin).searchParams.get('page') || ''); }
  catch(e){ return null; }
}

function renderPager(data){
  const pager = document.getElementById('pager');
  const info = document.getElementById('pagerInfo');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const pageInput = document.getElementById('page');
  const currentPage = Number(pageInput.value || 1);
  const prevPage = data.previous ? getPageFromUrl(data.previous) : null;
  const nextPage = data.next ? getPageFromUrl(data.next) : null;

  info.textContent = `Trang ${currentPage} ‚Ä¢ T·ªïng ${data.count ?? (data.results?.length || 0)}`;
  btnPrev.disabled = !prevPage && currentPage <= 1;
  btnNext.disabled = !nextPage;

  btnPrev.onclick = () => {
    const target = prevPage ? prevPage : Math.max(1, currentPage - 1);
    if (target === currentPage) return;
    pageInput.value = String(target);
    loadLinks();
  };
  btnNext.onclick = () => {
    const target = nextPage ? nextPage : (currentPage + 1);
    pageInput.value = String(target);
    loadLinks();
  };
  pager.classList.remove('hidden');
}

async function showStats(id, title){
  const res = await api(`/api/links/${id}/stats/?range=7d`);
  if(!res.ok){ alert('L·ªói t·∫£i stats'); return; }
  const data = await res.json();
  const labels = data.daily_clicks.map(d => d.date), values = data.daily_clicks.map(d => d.count);
  const wrap = el(`<div><canvas id="chart" height="120"></canvas><p class="text-sm text-slate-600 mt-2">T·ªïng 7 ng√†y: <b>${data.total_clicks}</b></p></div>`);
  openModal('Th·ªëng k√™: ' + title, wrap);
  new Chart(wrap.querySelector('#chart'), { type:'bar', data:{ labels, datasets:[{ label:'Clicks', data: values }] }, options:{ scales:{ y:{ beginAtZero:true } } } });
}

async function showQR(id, slug){
  const res = await api(`/api/links/${id}/qr/`);
  if(!res.ok){ alert('L·ªói l·∫•y QR'); return; }
  const blob = await res.blob(); const url = URL.createObjectURL(blob);
  const short = `${location.origin}/r/${slug}/`;
  const wrap = el(`
    <div class="text-center">
      <img class="mx-auto" src="${url}" alt="QR for ${slug}" />
      <p class="mt-2 text-sm">${short}</p>
      <div class="mt-3 flex gap-2 justify-center">
        <a href="${url}" download="${slug}.png"
           class="px-3 py-2 rounded bg-emerald-600 text-white">Download PNG</a>
        <button class="px-3 py-2 rounded bg-slate-700 text-white"
                onclick="copyToClipboard('${short}', this)">Copy link</button>
      </div>
    </div>`);
  openModal('QR cho ' + slug, wrap);
}

async function editTitle(id, oldTitle){
  const newTitle = prompt('Nh·∫≠p title m·ªõi:', oldTitle); if(newTitle===null) return;
  const res = await api(`/api/links/${id}/`, { method:'PATCH', body: JSON.stringify({ title: newTitle }) });
  if(!res.ok){ alert('L·ªói c·∫≠p nh·∫≠t'); return; } await loadLinks();
}

function editLink(id, currTitle, currTarget, currSlug){
  const form = el(`
    <div class="space-y-3">
      <div>
        <label class="block text-sm mb-1">Title</label>
        <input id="editTitleInput" class="w-full border rounded px-3 py-2" value="${currTitle}" />
      </div>
      <div>
        <label class="block text-sm mb-1">Target URL</label>
        <input id="editTargetInput" class="w-full border rounded px-3 py-2" value="${currTarget}" />
      </div>
      <div>
        <label class="block text-sm mb-1">Slug (ƒë·ªïi s·∫Ω ƒë·ªïi link c√¥ng khai)</label>
        <input id="editSlugInput" class="w-full border rounded px-3 py-2" value="${currSlug}" />
        <p class="text-xs text-slate-500 mt-1">ƒê·ªÉ tr·ªëng ƒë·ªÉ gi·ªØ nguy√™n. N·∫øu ƒë·∫∑t slug tr·ªëng v√† l∆∞u, h·ªá th·ªëng c√≥ th·ªÉ t·ª± sinh slug m·ªõi.</p>
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button class="px-3 py-2 rounded bg-slate-200" onclick="closeModal()">H·ªßy</button>
        <button class="px-3 py-2 rounded bg-emerald-600 text-white" onclick="saveEditLink(${id})">L∆∞u</button>
      </div>
      <p id="editErr" class="text-sm text-red-600"></p>
    </div>
  `);
  openModal('S·ª≠a link', form);
}

async function saveEditLink(id){
  const title = document.getElementById('editTitleInput').value.trim();
  const target_url = document.getElementById('editTargetInput').value.trim();
  const slug = document.getElementById('editSlugInput').value.trim();
  const errEl = document.getElementById('editErr');
  errEl.textContent = '';
  if(!title || !target_url){ errEl.textContent = 'Title v√† Target URL l√† b·∫Øt bu·ªôc.'; return; }
  const payload = { title, target_url };
  if (slug !== '') payload.slug = slug; // ƒë·ªÉ tr·ªëng th√¨ gi·ªØ nguy√™n
  const res = await api(`/api/links/${id}/`, { method:'PATCH', body: JSON.stringify(payload) });
  if(!res.ok){
    try { const data = await res.json(); errEl.textContent = typeof data === 'string' ? data : JSON.stringify(data); }
    catch(e){ errEl.textContent = 'L·ªói c·∫≠p nh·∫≠t'; }
    return;
  }
  closeModal();
  await loadLinks();
}
async function deleteLink(id){
  if(!confirm('Xo√° link n√†y?')) return;
  const res = await api(`/api/links/${id}/`, { method:'DELETE' });
  if(res.status!==204){ alert('Xo√° th·∫•t b·∫°i'); return; } await loadLinks();
}

document.getElementById('btnLogin').addEventListener('click', login);
document.getElementById('btnCreate').addEventListener('click', createLink);
document.getElementById('btnReload').addEventListener('click', loadLinks);
document.getElementById('btnLogout').addEventListener('click', logout);

window.addEventListener('load', ()=>{
  // Set default date to today in Vietnamese format
  const createdAtEl = document.getElementById('created_at');
  if (createdAtEl) createdAtEl.value = todayDDMMYYYY();
  const t=localStorage.getItem('access');
  const u=localStorage.getItem('username');
  if(t){ state.access=t; state.username=u || null; toast('ƒê√£ d√πng token s·∫µn c√≥'); updateAuthUI(); loadLinks(); }
  else { updateAuthUI(); }
});

// Auto-refresh helpers: refresh after click and when returning focus
let refreshTimer = null;
function scheduleRefresh(delay=1000){
  if(!state.access) return;
  if(refreshTimer) clearTimeout(refreshTimer);
  refreshTimer = setTimeout(async ()=>{ await loadLinks(); refreshTimer=null; }, delay);
}
window.addEventListener('focus', ()=>{ scheduleRefresh(200); });

// Clipboard helper with UI feedback
async function copyToClipboard(text, btnEl){
  try {
    await navigator.clipboard.writeText(text);
    const old = btnEl.textContent;
    btnEl.textContent = 'ƒê√£ copy!';
    btnEl.classList.remove('bg-slate-700');
    btnEl.classList.add('bg-emerald-600');
    setTimeout(()=>{
      btnEl.textContent = old;
      btnEl.classList.remove('bg-emerald-600');
      btnEl.classList.add('bg-slate-700');
    }, 1200);
  } catch(e){
    alert('Kh√¥ng copy ƒë∆∞·ª£c. H√£y copy th·ªß c√¥ng.');
  }
}
</script>
</body>
</html>
